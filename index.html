<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel & Tourism</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Simple spinner */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Hide scrollbar when modal is open */
        .modal-open {
            overflow: hidden;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div class="flex items-center justify-center min-h-screen">
        <!-- Main container for all content -->
        <div class="container p-4 mx-auto">

            <!-- This title is visible on Login/Register pages -->
            <h1 id="main-title" class="text-5xl font-bold text-center text-blue-700 mb-8 drop-shadow-md">
                Travel & Tourism
            </h1>

            <!-- Error Message Box (hidden by default) -->
            <div id="error-box"
                class="w-full max-w-md p-3 my-4 text-sm text-red-700 bg-red-100 rounded-lg mx-auto hidden" role="alert">
                <span class="font-medium">Error:</span> <span id="error-message"></span>
            </div>

            <!-- Login Form (Visible by default) -->
            <div id="login-page" class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md mx-auto">
                <h2 class="text-3xl font-bold text-center text-gray-900">Sign In</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-usernameOrEmail" class="block text-sm font-medium text-gray-700">Username or
                            Email</label>
                        <input id="login-usernameOrEmail" name="usernameOrEmail" type="text" required
                            class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="johndoe123 or you@example.com">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input id="login-password" name="password" type="password" required
                            class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="••••••••">
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-sm">
                            <a href="#" class="font-medium text-blue-600 hover:text-blue-500">
                                Forgot your password?
                            </a>
                        </div>
                    </div>
                    <div>
                        <button id="login-button" type="submit"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                            <span class="btn-text">Sign In</span>
                            <div class="spinner w-5 h-5 border-t-2 border-white border-solid rounded-full hidden"></div>
                        </button>
                    </div>
                </form>
                <p class="text-sm text-center text-gray-600">
                    Don't have an account?
                    <button id="show-register" class="font-medium text-blue-600 hover:text-blue-500">
                        Sign Up
                    </button>
                </p>
            </div>

            <!-- Register Form (Hidden by default) -->
            <div id="register-page" class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md mx-auto hidden">
                <h2 class="text-3xl font-bold text-center text-gray-900">Create Account</h2>
                <form id="register-form" class="space-y-6">
                    <div>
                        <label for="register-full_name" class="block text-sm font-medium text-gray-700">Full
                            Name</label>
                        <input id="register-full_name" name="full_name" type="text" required
                            class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="John Doe">
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email
                            Address</label>
                        <input id="register-email" name="email" type="email" required
                            class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="register-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input id="register-username" name="username" type="text" required
                            class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="johndoe123">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input id="register-password" name="password" type="password" required
                            class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="•••••••• (6+ characters)">
                    </div>
                    <div>
                        <label for="register-confirmPassword" class="block text-sm font-medium text-gray-700">Confirm
                            Password</label>
                        <input id="register-confirmPassword" name="confirmPassword" type="password" required
                            class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            placeholder="••••••••">
                    </div>
                    <div>
                        <button id="register-button" type="submit"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                            <span class="btn-text">Sign Up</span>
                            <div class="spinner w-5 h-5 border-t-2 border-white border-solid rounded-full hidden"></div>
                        </button>
                    </div>
                </form>
                <p class="text-sm text-center text-gray-600">
                    Already have an account?
                    <button id="show-login" class="font-medium text-blue-600 hover:text-blue-500">
                        Sign In
                    </button>
                </p>
            </div>

            <!-- === DASHBOARD PAGE === (Hidden by default) -->
            <div id="dashboard-page" class="w-full max-w-6xl p-4 md:p-8 bg-gray-100 rounded-lg mx-auto hidden">

                <!-- Dashboard Header -->
                <header
                    class="flex flex-col sm:flex-row justify-between sm:items-center mb-8 pb-4 border-b border-gray-200 bg-white p-6 rounded-lg shadow">
                    <div>
                        <h1 id="welcome-title" class="text-3xl font-bold text-gray-900">Welcome!</h1>
                        <p class="text-gray-600">Where would you like to go today?</p>
                    </div>
                    <button id="logout-button"
                        class="mt-4 sm:mt-0 flex items-center justify-center gap-2 w-full sm:w-auto px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        <!-- Logout Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                        <span>Logout</span>
                    </button>
                </header>

                <!-- Search Bar -->
                <div class="mb-8 p-6 bg-white rounded-lg shadow">
                    <div class="relative">
                        <input type="text" id="search-bar"
                            placeholder="Search for destinations, hotels, or activities..."
                            class="w-full p-4 pl-12 text-lg border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <!-- Search Icon -->
                        <svg class="absolute w-6 h-6 text-gray-400 left-4 top-1/2 -translate-y-1/2"
                            xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                    </div>
                </div>

                <!-- Featured Destinations -->
                <section>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 px-2">Featured Destinations</h2>
                    <div id="destination-cards-container" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">

                        <!-- Destination Card 1 -->
                        <div
                            class="destination-card bg-white rounded-lg shadow-lg overflow-hidden transform transition-transform hover:scale-105 duration-300">
                            <img src="https://placehold.co/600x400/3498db/ffffff?text=Paris" alt="Paris"
                                class="w-full h-48 object-cover"
                                onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Not+Found';">
                            <div class="p-4">
                                <h3 class="destination-name text-lg font-bold text-gray-900 flex items-center gap-2">
                                    <!-- Map Pin Icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                        <circle cx="12" cy="10" r="3" />
                                    </svg>
                                    Paris, France
                                </h3>
                                <p class="mt-2 text-sm text-gray-600">Experience the city of love, art, and iconic
                                    landmarks.</p>
                                <p class="text-xl font-bold text-blue-700 mt-2">$1,200</p>
                                <button
                                    class="book-now-btn w-full mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                                    data-name="Paris, France" data-price="$1,200">
                                    Book Now
                                </button>
                            </div>
                        </div>

                        <!-- Destination Card 2 -->
                        <div
                            class="destination-card bg-white rounded-lg shadow-lg overflow-hidden transform transition-transform hover:scale-105 duration-300">
                            <img src="https://placehold.co/600x400/e74c3c/ffffff?text=Kyoto" alt="Kyoto"
                                class="w-full h-48 object-cover"
                                onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Not+Found';">
                            <div class="p-4">
                                <h3 class="destination-name text-lg font-bold text-gray-900 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                        <circle cx="12" cy="10" r="3" />
                                    </svg>
                                    Kyoto, Japan
                                </h3>
                                <p class="mt-2 text-sm text-gray-600">Explore ancient temples, serene gardens, and rich
                                    traditions.</p>
                                <p class="text-xl font-bold text-blue-700 mt-2">$1,800</p>
                                <button
                                    class="book-now-btn w-full mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                                    data-name="Kyoto, Japan" data-price="$1,800">
                                    Book Now
                                </button>
                            </div>
                        </div>

                        <!-- Destination Card 3 -->
                        <div
                            class="destination-card bg-white rounded-lg shadow-lg overflow-hidden transform transition-transform hover:scale-105 duration-300">
                            <img src="https://placehold.co/600x400/f1c40f/ffffff?text=Cairo" alt="Cairo"
                                class="w-full h-48 object-cover"
                                onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Not+Found';">
                            <div class="p-4">
                                <h3 class="destination-name text-lg font-bold text-gray-900 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                        <circle cx="12" cy="10" r="3" />
                                    </svg>
                                    Cairo, Egypt
                                </h3>
                                <p class="mt-2 text-sm text-gray-600">Witness the majestic pyramids and uncover ancient
                                    history.</p>
                                <p class="text-xl font-bold text-blue-700 mt-2">$950</p>
                                <button
                                    class="book-now-btn w-full mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                                    data-name="Cairo, Egypt" data-price="$950">
                                    Book Now
                                </button>
                            </div>
                        </div>

                        <!-- Destination Card 4 -->
                        <div
                            class="destination-card bg-white rounded-lg shadow-lg overflow-hidden transform transition-transform hover:scale-105 duration-300">
                            <img src="https://placehold.co/600x400/2ecc71/ffffff?text=Rio" alt="Rio"
                                class="w-full h-48 object-cover"
                                onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Not+Found';">
                            <div class="p-4">
                                <h3 class="destination-name text-lg font-bold text-gray-900 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                        <circle cx="12" cy="10" r="3" />
                                    </svg>
                                    Rio, Brazil
                                </h3>
                                <p class="mt-2 text-sm text-gray-600">Vibrant culture, stunning beaches, and the iconic
                                    Christ the Redeemer.</p>
                                <p class="text-xl font-bold text-blue-700 mt-2">$1,100</p>
                                <button
                                    class="book-now-btn w-full mt-4 px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                                    data-name="Rio, Brazil" data-price="$1,100">
                                    Book Now
                                </button>
                            </div>
                        </div>

                        <!-- No search results message -->
                        <p id="no-search-results-msg" class="text-gray-500 hidden col-span-full text-center py-8">
                            No destinations found matching your search.
                        </p>

                    </div>
                </section>

                <!-- Your Bookings Section -->
                <section class="mt-12">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 px-2">Your Bookings</h2>
                    <div class="p-8 text-center bg-white rounded-lg shadow-lg border border-gray-200">
                        <p id="no-bookings-msg" class="text-gray-500">You have no active bookings.</p>
                        <!-- Bookings will be dynamically added here -->
                        <div id="bookings-list" class="space-y-4 text-left"></div>
                    </div>
                </section>

            </div>
            <!-- === END OF DASHBOARD PAGE === -->

        </div>
    </div>

    <!-- === BOOKING MODAL === -->
    <div id="booking-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Confirm Your Booking</h2>
            <div class="space-y-3">
                <p class="text-lg">
                    <span class="font-semibold text-gray-700">Destination:</span>
                    <span id="modal-destination-name" class="text-gray-900"></span>
                </p>
                <p class="text-lg">
                    <span class="font-semibold text-gray-700">Price:</span>
                    <span id="modal-price" class="text-blue-700 font-bold"></span>
                </p>
                <p class="text-sm text-gray-500">
                    This will save the booking to your account.
                </p>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-booking-btn"
                    class="px-4 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 font-medium">
                    Cancel
                </button>
                <button id="confirm-booking-btn"
                    class="px-4 py-2 rounded-lg text-white bg-blue-600 hover:bg-blue-700 font-medium flex items-center justify-center w-36">
                    <span class="btn-text">Confirm Booking</span>
                    <div class="spinner w-5 h-5 border-t-2 border-white border-solid rounded-full hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- === SUCCESS MODAL === -->
    <div id="success-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Booking Successful!</h2>
            <p class="text-gray-600 mb-6">Your trip has been saved to your account.</p>
            <button id="close-success-btn"
                class="w-full px-4 py-2 rounded-lg text-white bg-blue-600 hover:bg-blue-700 font-medium">
                Done
            </button>
        </div>
    </div>


    <!-- All JavaScript Logic -->
    <script>
        // --- Configuration ---
        // === THIS IS THE IMPORTANT CHANGE ===
        const API_BASE_URL = 'https://travel-backend-ydgz.onrender.com';

        // --- Element Selectors ---
        const mainTitle = document.getElementById('main-title');
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const bodyEl = document.body;

        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');

        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-button');

        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');

        const bookingModal = document.getElementById('booking-modal');
        const successModal = document.getElementById('success-modal');
        const cancelBookingBtn = document.getElementById('cancel-booking-btn');
        const confirmBookingBtn = document.getElementById('confirm-booking-btn');
        const closeSuccessBtn = document.getElementById('close-success-btn');
        const modalDestinationName = document.getElementById('modal-destination-name');
        const modalPrice = document.getElementById('modal-price');
        const noBookingsMsg = document.getElementById('no-bookings-msg');
        const bookingsList = document.getElementById('bookings-list');

        const searchBar = document.getElementById('search-bar');
        const destinationCardsContainer = document.getElementById('destination-cards-container');
        const noSearchResultsMsg = document.getElementById('no-search-results-msg');


        // --- Helper Functions ---

        function showPage(page) {
            mainTitle.classList.add('hidden');
            loginPage.classList.add('hidden');
            registerPage.classList.add('hidden');
            dashboardPage.classList.add('hidden');
            errorBox.classList.add('hidden');

            if (page === 'login') {
                mainTitle.classList.remove('hidden');
                loginPage.classList.remove('hidden');
            } else if (page === 'register') {
                mainTitle.classList.remove('hidden');
                registerPage.classList.remove('hidden');
            } else if (page === 'dashboard') {
                dashboardPage.classList.remove('hidden');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
        }

        function showLoading(button) {
            button.disabled = true;
            button.querySelector('.btn-text').classList.add('hidden');
            button.querySelector('.spinner').classList.remove('hidden');
        }

        function hideLoading(button) {
            button.disabled = false;
            button.querySelector('.btn-text').classList.remove('hidden');
            button.querySelector('.spinner').classList.add('hidden');
        }

        function showBookingModal(name, price) {
            modalDestinationName.textContent = name;
            modalPrice.textContent = price;
            bookingModal.classList.remove('hidden');
            bodyEl.classList.add('modal-open');
        }

        function hideBookingModal() {
            bookingModal.classList.add('hidden');
            bodyEl.classList.remove('modal-open');
        }

        function showSuccessModal() {
            successModal.classList.remove('hidden');
            bodyEl.classList.add('modal-open');
        }

        function hideSuccessModal() {
            successModal.classList.add('hidden');
            bodyEl.classList.remove('modal-open');
        }

        // --- UPDATED: Function to add booking to list ---
        function addBookingToList(booking) {
            // Get the name and price from the booking object
            const name = booking.destinationName;
            const price = booking.price;

            // Hide the "no bookings" message
            noBookingsMsg.classList.add('hidden');

            const bookingItem = document.createElement('div');
            bookingItem.className = 'flex justify-between items-center p-4 bg-gray-100 rounded-lg shadow-sm text-left';
            bookingItem.innerHTML = `
        <div>
          <p class="font-semibold text-gray-800">${name}</p>
          <p class="text-sm text-gray-600">Price: ${price}</p>
        </div>
        <span class="text-sm font-medium text-green-600">Confirmed</span>
      `;
            bookingsList.appendChild(bookingItem);
        }

        // --- NEW: Function to get bookings from DB ---
        async function fetchAndDisplayBookings() {
            const token = localStorage.getItem('token');
            if (!token) return; // Not logged in

            // Clear existing list
            bookingsList.innerHTML = '';

            try {
                const res = await fetch(`${API_BASE_URL}/api/bookings`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}` // Send the token
                    }
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.message || 'Could not fetch bookings.');
                }

                const bookings = await res.json();

                if (bookings.length === 0) {
                    noBookingsMsg.classList.remove('hidden');
                } else {
                    noBookingsMsg.classList.add('hidden');
                    // Add each booking from the DB to the list
                    bookings.forEach(booking => {
                        addBookingToList(booking);
                    });
                }

            } catch (err) {
                console.error("Fetch bookings error:", err.message);
                // Don't show a scary error, just show the no bookings message
                noBookingsMsg.classList.remove('hidden');
            }
        }

        // --- UPDATED: Dashboard function ---
        function updateDashboard() {
            const token = localStorage.getItem('token');
            if (token) {
                const userFullName = localStorage.getItem('userFullName');
                const welcomeTitle = document.getElementById('welcome-title');

                if (userFullName) {
                    welcomeTitle.textContent = `Welcome, ${userFullName}!`;
                } else {
                    welcomeTitle.textContent = 'Welcome!';
                }
                showPage('dashboard');

                // --- NEW: Fetch bookings when dashboard loads ---
                fetchAndDisplayBookings();

            } else {
                showPage('login');
            }
        }

        // --- Event Listeners ---

        // Page navigation
        showRegisterBtn.addEventListener('click', () => showPage('register'));
        showLoginBtn.addEventListener('click', () => showPage('login'));

        // Logout
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('userFullName');

            // Clear bookings list and show message
            bookingsList.innerHTML = '';
            noBookingsMsg.classList.remove('hidden');

            searchBar.value = ''; // Clear search
            searchBar.dispatchEvent(new Event('input')); // Trigger search update

            showPage('login');
        });

        // Login Form Submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = document.getElementById('login-button');
            showLoading(button);
            errorBox.classList.add('hidden');

            const usernameOrEmail = document.getElementById('login-usernameOrEmail').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usernameOrEmail, password })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Login failed.');

                localStorage.setItem('token', data.token);
                localStorage.setItem('userFullName', data.user.full_name);
                updateDashboard(); // This will now also fetch bookings
                loginForm.reset();

            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading(button);
            }
        });

        // Register Form Submission
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = document.getElementById('register-button');
            showLoading(button);
            errorBox.classList.add('hidden');

            const full_name = document.getElementById('register-full_name').value;
            const email = document.getElementById('register-email').value;
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirmPassword').value;

            if (password !== confirmPassword) {
                showError('Passwords do not match.');
                hideLoading(button);
                return;
            }
            if (password.length < 6) {
                showError('Password must be at least 6 characters long.');
                hideLoading(button);
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name, email, username, password })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Registration failed.');

                localStorage.setItem('token', data.token);
                localStorage.setItem('userFullName', data.user.full_name);
                updateDashboard(); // This will now also fetch bookings
                registerForm.reset();

            } catch (err) {
                showError(err.message);
            } finally {
                hideLoading(button);
            }
        });

        // Search Bar Event Listener
        searchBar.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const cards = destinationCardsContainer.querySelectorAll('.destination-card');
            let visibleCardCount = 0;

            cards.forEach(card => {
                const destinationNameEl = card.querySelector('.destination-name');
                if (destinationNameEl) {
                    const destinationName = destinationNameEl.textContent.toLowerCase();
                    if (destinationName.includes(searchTerm)) {
                        card.classList.remove('hidden');
                        visibleCardCount++;
                    } else {
                        card.classList.add('hidden');
                    }
                }
            });

            if (visibleCardCount === 0 && cards.length > 0) {
                noSearchResultsMsg.classList.remove('hidden');
            } else {
                noSearchResultsMsg.classList.add('hidden');
            }
        });

        // --- UPDATED: Modal Event Listeners ---

        // Cancel booking
        cancelBookingBtn.addEventListener('click', () => {
            hideBookingModal();
        });

        // Close success modal
        closeSuccessBtn.addEventListener('click', () => {
            hideSuccessModal();
        });

        // Confirm booking - THIS IS NOW A REAL API CALL
        confirmBookingBtn.addEventListener('click', async () => {
            const token = localStorage.getItem('token');
            const name = modalDestinationName.textContent;
            const price = modalPrice.textContent;

            // Show loading spinner
            showLoading(confirmBookingBtn);

            try {
                // --- THIS IS THE NEW API CALL ---
                const res = await fetch(`${API_BASE_URL}/api/bookings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // Send the token
                    },
                    body: JSON.stringify({
                        destinationName: name,
                        price: price
                    })
                });

                const newBooking = await res.json();

                if (!res.ok) {
                    throw new Error(newBooking.message || "Booking failed.");
                }

                // --- Success ---
                hideLoading(confirmBookingBtn);
                hideBookingModal();
                showSuccessModal();

                // Add the *new booking from the server* to the list
                addBookingToList(newBooking);

            } catch (err) {
                // Show error right in the modal for now
                hideLoading(confirmBookingBtn);
                // This is a simple way to show an error
                alert("Booking failed: " + err.message);
            }
        });


        // --- Initial Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard(); // This will run and check for a token

            // Add click listeners to all "Book Now" buttons
            const allBookNowBtns = document.querySelectorAll('.book-now-btn');
            allBookNowBtns.forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const name = btn.getAttribute('data-name');
                    const price = btn.getAttribute('data-price');
                    showBookingModal(name, price);
                });
            });

        });

    </script>
</body>

</html>